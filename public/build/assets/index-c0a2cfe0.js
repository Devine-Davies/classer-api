class S{constructor(){this.token=null,this.tab="stats",this.handlers={logs:()=>g("app.log",this.token),invites:()=>E(this.token),stats:()=>u(this.token)}}switchTab(e){var o,s;this.tab=e,(s=(o=this.handlers)[e])==null||s.call(o)}}window.tabUI=new S;document.addEventListener("DOMContentLoaded",()=>{T(),b()});document.addEventListener("htmx:beforeRequest",()=>{document.querySelector(".error-message").classList.add("hidden"),document.querySelector("input[type=submit]").classList.add("pointer-events-none")});document.addEventListener("htmx:afterRequest",t=>{JSON.parse(t.detail.xhr.response),setTimeout(()=>{if(!t.detail.successful){document.querySelector("input[type=submit]").classList.remove("pointer-events-none");const o=document.querySelector(".error-message");o.innerHTML="Something went wrong, please try again.",o.classList.remove("hidden");return}document.getElementById("form").classList.add("hidden"),document.querySelector("[x-data]").classList.remove("hidden");const e=t.detail.xhr.getResponseHeader("x-token");tabUI.token=e,tabUI.switchTab("stats"),A(e)},500)});const T=()=>{grecaptcha.ready(()=>{grecaptcha.execute("6LdNKLMpAAAAAFPilXVAY_0W7QTOEYkV6rgYZ6Yq",{action:"submit"}).then(t=>{document.querySelector("#form form").insertAdjacentHTML("beforeend",`<div class="hidden">
                    <input type="hidden" name="grc" value="${t}">
                </div>`)})})},b=()=>{document.querySelectorAll(".eye-show-password").forEach(t=>{t.addEventListener("click",()=>{const e=t.previousElementSibling;e.type=e.type==="password"?"text":"password"})})};let m=null;const A=t=>{m&&clearInterval(m),m=setInterval(()=>{u(t),g("app.log",t)},9e5)},E=t=>{const e=document.getElementById("invite-form");e&&e.setAttribute("hx-headers",JSON.stringify({Authorization:`Bearer ${t}`}))},u=t=>{fetch(pageUrl+"/api/admin/stats",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+t}}).then(e=>{e.json().then(o=>{const s=document.getElementById("stats-template").innerHTML,r=document.getElementById("stats-container"),n=I(o.data),i=Object.entries(n).map(([l,a])=>a.map(c=>h(s,{...c,stat:c.converter(o.data[c.key]||0)})).join(""));r.innerHTML=i.join("")})})},g=(t,e)=>{fetch(pageUrl+"/api/admin/logs/"+t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e}}).then(o=>{o.json().then(s=>{const r=document.getElementById("logs-template").innerHTML,n=document.getElementById("logs-container"),i=(s??[]).reverse().filter(l=>l.trim()!=="").map(l=>{const a=l.match(/^\[(.*?)\]\s+(\w+)\.(\w+):\s+\[(.*?)\]\s+(.*)$/);if(!a)return"";const[,c,M,y,_,v]=a,p={INFO:"⚪️",WARNING:"🟡",ERROR:"🔴",DEBUG:"🟤",default:"🟤"},w=p[y.toUpperCase()]||p.default,d=v.split("|"),k=d[0].trim(),f=d.length>1?d.slice(1).join("|").trim():null;return h(r,{timestamp:(L=>new Date(L).toLocaleString())(c),context:_,message:k,data:f,icon:w})});n.innerHTML=i.join(""),Alpine.initTree(n)})})},I=t=>{const e=a=>a.toLocaleString(),o=a=>(a/1024/1024).toFixed(2)+" MB",s="bg-blue-500",r="bg-green-500",n="bg-yellow-500";return C({total_users:{icon:"people",title:"Total Users",color:s,converter:e},total_monthly_registers:{icon:"star",title:"Monthly Registers",color:s,converter:e},total_monthly_logins:{icon:"login",title:"Monthly Logins",color:r,converter:e},total_weekly_registers:{icon:"star",title:"Weekly Registers",color:s,converter:e},total_weekly_logins:{icon:"login",title:"Weekly Logins",color:r,converter:e},cs_active_weekly_total:{icon:"storage",title:"CS - Weekly Active",color:n,converter:e},cs_active_weekly_size:{icon:"storage",title:"CS - Weekly Size Active",color:n,converter:o},cs_deleted_weekly_total:{icon:"storage",title:"CS - Weekly Deleted",color:n,converter:e},cs_deleted_weekly_size:{icon:"storage",title:"CS - Weekly Size Deleted",color:n,converter:o},cs_total:{icon:"cloud",title:"CS - Total Active/Deleted",color:n,converter:e},cs_size:{icon:"cloud",title:"CS - Total Size Active/Deleted",color:n,converter:o}},{registrationKeys:["total_users","total_monthly_registers","total_weekly_registers"],loginKeys:["total_monthly_logins","total_weekly_logins"],csKeys:["cs_total","cs_size","cs_active_weekly_total","cs_active_weekly_size","cs_deleted_weekly_total","cs_deleted_weekly_size"]})},C=(t,e)=>{const o={};for(const[s,r]of Object.entries(e))o[s]=r.reduce((n,i)=>(t[i]&&n.push({key:i,...t[i]}),n),[]);return o},h=(t,e)=>t.replace(/\${(.*?)}/g,(o,s)=>e[s.trim()]);
