class T{constructor(){this.token=null,this.tab="stats",this.handlers={logs:()=>u("app.log",this.token),stats:()=>g(this.token)}}switchTab(e){var o,s;this.tab=e,(s=(o=this.handlers)[e])==null||s.call(o)}}window.tabUI=new T;document.addEventListener("DOMContentLoaded",()=>{b(),f()});document.addEventListener("htmx:beforeRequest",()=>{document.querySelector(".error-message").classList.add("hidden"),document.querySelector("input[type=submit]").classList.add("pointer-events-none")});document.addEventListener("htmx:afterRequest",t=>{JSON.parse(t.detail.xhr.response),setTimeout(()=>{if(!t.detail.successful){document.querySelector("input[type=submit]").classList.remove("pointer-events-none");const o=document.querySelector(".error-message");o.innerHTML="Something went wrong, please try again.",o.classList.remove("hidden");return}document.getElementById("form").classList.add("hidden"),document.querySelector("[x-data]").classList.remove("hidden");const e=t.detail.xhr.getResponseHeader("x-token");tabUI.token=e,tabUI.switchTab("stats"),A(e)},500)});const b=()=>{grecaptcha.ready(()=>{grecaptcha.execute("6LdNKLMpAAAAAFPilXVAY_0W7QTOEYkV6rgYZ6Yq",{action:"submit"}).then(t=>{document.querySelector("#form form").insertAdjacentHTML("beforeend",`<div class="hidden">
                    <input type="hidden" name="grc" value="${t}">
                </div>`)})})},f=()=>{document.querySelectorAll(".eye-show-password").forEach(t=>{t.addEventListener("click",()=>{const e=t.previousElementSibling;e.type=e.type==="password"?"text":"password"})})};let p=null;const A=t=>{p&&clearInterval(p),p=setInterval(()=>{g(t),u("app.log",t)},9e5)},g=t=>{fetch(pageUrl+"/api/admin/stats",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+t}}).then(e=>{e.json().then(o=>{const s=document.getElementById("stats-template").innerHTML,r=document.getElementById("stats-container"),n=E(o.data),l=Object.entries(n).map(([c,a])=>a.map(i=>h(s,{...i,stat:i.converter(o.data[i.key]||0)})).join(""));r.innerHTML=l.join("")})})},u=(t,e)=>{fetch(pageUrl+"/api/admin/logs/"+t,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+e}}).then(o=>{o.json().then(s=>{const r=document.getElementById("logs-template").innerHTML,n=document.getElementById("logs-container"),l=(s??[]).reverse().filter(c=>c.trim()!=="").map(c=>{const a=c.match(/^\[(.*?)\]\s+(\w+)\.(\w+):\s+\[(.*?)\]\s+(.*)$/);if(!a)return"";const[,i,C,y,_,v]=a,m={INFO:"⚪️",WARNING:"🟡",ERROR:"🔴",DEBUG:"🟤",default:"🟤"},w=m[y.toUpperCase()]||m.default,d=v.split("|"),k=d[0].trim(),L=d.length>1?d.slice(1).join("|").trim():null;return h(r,{timestamp:(S=>new Date(S).toLocaleString())(i),context:_,message:k,data:L,icon:w})});n.innerHTML=l.join(""),Alpine.initTree(n)})})},E=t=>{console.log("Mapping stats response:",t);const e=a=>a.toLocaleString(),o=a=>(a/1024/1024).toFixed(2)+" MB",s="bg-blue-500",r="bg-green-500",n="bg-yellow-500";return M({total_users:{icon:"people",title:"Total Users",color:s,converter:e},total_monthly_registers:{icon:"star",title:"Monthly Registers",color:s,converter:e},total_monthly_logins:{icon:"login",title:"Monthly Logins",color:r,converter:e},total_weekly_registers:{icon:"star",title:"Weekly Registers",color:s,converter:e},total_weekly_logins:{icon:"login",title:"Weekly Logins",color:r,converter:e},cs_active_weekly_total:{icon:"storage",title:"CS - Weekly Active",color:n,converter:e},cs_active_weekly_size:{icon:"storage",title:"CS - Weekly Size Active",color:n,converter:o},cs_deleted_weekly_total:{icon:"storage",title:"CS - Weekly Deleted",color:n,converter:e},cs_deleted_weekly_size:{icon:"storage",title:"CS - Weekly Size Deleted",color:n,converter:o},cs_total:{icon:"cloud",title:"CS - Total Active/Deleted",color:n,converter:e},cs_size:{icon:"cloud",title:"CS - Total Size Active/Deleted",color:n,converter:o}},{registrationKeys:["total_users","total_monthly_registers","total_weekly_registers"],loginKeys:["total_monthly_logins","total_weekly_logins"],csKeys:["cs_total","cs_size","cs_active_weekly_total","cs_active_weekly_size","cs_deleted_weekly_total","cs_deleted_weekly_size"]})},M=(t,e)=>{const o={};for(const[s,r]of Object.entries(e))o[s]=r.reduce((n,l)=>(t[l]&&n.push({key:l,...t[l]}),n),[]);return o},h=(t,e)=>t.replace(/\${(.*?)}/g,(o,s)=>e[s.trim()]);
